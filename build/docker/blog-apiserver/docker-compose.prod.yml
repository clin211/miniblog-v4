# 生产环境 Docker Compose 配置
#
# 使用方法：
# 1. 确保已构建镜像：make image PLATFORM=linux_amd64 VERSION=vX.X.X IMAGES=blog-apiserver
# 2. 准备配置文件：configs/blog-apiserver.prod.yaml
# 3. 启动服务：docker compose -f docker-compose.prod.yml up -d
# 4. 查看日志：docker compose -f docker-compose.prod.yml logs -f
#
# 跨服务器部署说明：
# - 数据库/Redis/OTEL 在其他服务器：直接在配置文件中填写 IP:Port
# - 数据库/Redis/OTEL 在同一宿主机：使用 host.docker.internal:Port（已配置 extra_hosts）
# - 数据库/Redis/OTEL 在同一 Docker 网络：取消注释 networks 配置，使用服务名

services:
  blog-apiserver:
    # 镜像版本（部署时替换为实际版本）
    image: miniblog-v4/blog-apiserver:${VERSION:-latest}

    container_name: blog-apiserver
    hostname: blog-apiserver

    # 环境变量配置
    environment:
      - TZ=Asia/Shanghai
      # 可以通过环境变量覆盖配置（如果应用支持）
      # - LOG_LEVEL=info
      # - DATABASE_HOST=192.168.1.100

    # 配置文件挂载
    # 生产环境：挂载实际的生产配置文件
    volumes:
      - ./configs/blog-apiserver.prod.yaml:/app/configs/blog-apiserver.yaml:ro
      # 如果需要持久化日志（当 output-mode 为 file 时）
      # - ./logs:/app/logs

    # 端口映射
    ports:
      - "5556:5556"

    # 重启策略 - 生产环境始终重启
    restart: always

    # 启动命令
    command: ["-c", "/app/configs/blog-apiserver.yaml"]

    # 资源限制（根据实际情况调整）
    deploy:
      resources:
        limits:
          cpus: '2.0'      # 限制使用 2 个 CPU 核心
          memory: 2G        # 限制内存使用 2GB
        reservations:
          cpus: '0.5'      # 保留 0.5 个 CPU 核心
          memory: 512M      # 保留 512MB 内存

    # 配置 extra_hosts 使容器能访问宿主机服务
    # 对于 Linux 服务器，host.docker.internal 需要此配置
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # 安全配置
    security_opt:
      - no-new-privileges:true
    read_only: false  # 如果应用需要写入临时文件，保持为 false

    # 日志配置 - 生产环境限制日志大小
    logging:
      driver: json-file
      options:
        max-size: "50m"   # 单个日志文件最大 50MB
        max-file: "5"      # 保留 5 个日志文件
        compress: "true"   # 压缩旧日志文件

    # 健康检查（scratch 镜像限制，实际监控应使用外部工具）
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s  # 给应用 15 秒启动时间

    # 如果所有依赖服务都在同一 Docker 网络，取消注释以下配置
    # networks:
    #   - app-network
    # depends_on:
    #   postgres:
    #     condition: service_healthy
    #   redis:
    #     condition: service_healthy
    #   otel-collector:
    #     condition: service_healthy

# 如果使用 Docker 网络，取消注释以下配置
# networks:
#   app-network:
#     external: true  # 使用外部已存在的网络
#     # 或者创建新网络
#     # driver: bridge
#     # ipam:
#     #   config:
#     #     - subnet: 172.28.0.0/16

