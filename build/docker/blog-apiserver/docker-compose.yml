services:
  blog-apiserver:
    # 使用最新构建的镜像版本
    image: miniblog-v4/blog-apiserver:v0.0.5-alpha
    build:
      # 使用相对路径，指向项目根目录（从 docker-compose.yml 所在目录向上三级）
      context: ../../..
      dockerfile: build/docker/blog-apiserver/Dockerfile
      args:
        OS: linux
        ARCH: amd64
        GOPROXY: https://goproxy.cn,direct
    container_name: blog-apiserver
    hostname: blog-apiserver

    # 环境变量配置
    environment:
      - TZ=Asia/Shanghai

    # 配置文件挂载（使用相对路径）
    volumes:
      - ../../../configs/blog-apiserver.docker.yaml:/app/configs/blog-apiserver.yaml:ro
      - /etc/localtime:/etc/localtime:ro
      - /usr/share/zoneinfo/Asia/Shanghai:/usr/share/zoneinfo/Asia/Shanghai:ro

    # 端口映射
    ports:
      - "5556:5556"

    # 重启策略
    restart: unless-stopped

    # 启动命令
    command: ["-c", "/app/configs/blog-apiserver.yaml"]

    # 配置 extra_hosts 使容器能访问宿主机服务
    # 这对于 Linux 服务器特别重要，因为 host.docker.internal 在 Linux 上默认不存在
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # 安全配置
    security_opt:
      - no-new-privileges:true

    # 日志配置
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # 健康检查（使用外部 curl 检查，因为 scratch 镜像没有 shell 工具）
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]  # scratch 镜像无法内部检查，依赖外部监控
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s